<!DOCTYPE html>
<html>
  <head>

    <meta charset="utf-8"/>
    <title>
      Анализатор логов
    </title>

    <script src="js/xml2json.js"></script>
	<script src="js/zip.js"></script>
    <script src="https://x2js.googlecode.com/hg/xml2json.js"></script>
    <script src="http://yastatic.net/jquery/1.8.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-dateFormat/1.0/jquery.dateFormat.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/zeroclipboard/1.3.5/ZeroClipboard.min.js"></script>
    <script src="js/HashTable.js"></script>    
    <script src="//cdn.datatables.net/1.10.0/js/jquery.dataTables.js"></script>
    <script src="js/fileParser.js"></script>        
  
  <link rel="stylesheet" href="css/jquery.dataTables.css"/> 
  <link rel="stylesheet" href="css/analyzer.table.css"/> 
  
  <meta name="description" content=""/>
  </head>
  <body class="page" onload="checkFileAPI();">  

      <div id="uploadScreen">              
        <div class="body">

           <div class="upload__screen__block">
            <h2 class="header">Загрузите лог для анализа</h2>
            <p class="sub-header sub-header_align_left">Лог создается при сканировании сайта инструментом и содержит информацию об окружении сайта (данные о вебсервере, интерпретаторе, системах контроля версий) а также файлах. Загружать лог можно как в виде архива, так и в виде распакованного xml.</p>

            <input accept="application/zip, text/xml"  class="upload__screen__button" type="file" name="report" onchange="turnOnTableScreen(); readText(this);">
            <span class="button button_theme_action i-bem button_js_inited button_hovered" style="margin-top: 40px;">Загрузить файл</span>
            </input>

        </div>
        <div class="body__spacer"></div>
        <div class="footer">
            <a class="b-link footer__item" href="#">Обратная связь</a>
            <a class="b-link footer__item" href="#">Помощь</a>
            <div class="footer__item footer__item_type_copyright">©&nbsp;2001&mdash;2013</div>
        </div>
    </div>
    
      </div>
           
    <div id="tableScreen">    
        <div class="body body_full_height">
            <div class="header_div">
                <div class="header_left_block">
                    <h1 class="header header_type_main">
                        Manul: Анализатор логов
                    </h1>
                    <!-- <h2 class="head__sub-header">
                        Список файлов
                    </h2> -->
                    <p class="head__description">
                        Анализатор логов Manul. Для эффективного поиска вредоносных файлов следует добавить вайтлисты или полученные ранее логи. В качестве фильтров можно задать маску имени файлов и дату создания.
                    </p>
                </div>
                <div class="header_right_block">
                    <div class="filter_list">
                         <h4 style="margin-bottom: 0px;">Подключенные файлы-фильтры:</h4>
                         <table id="filter_file_list" style="text-align: left; float: right; border-spacing: 10px; overflow: hidden;">
                             <thead>
                                 <th>Файл</th><th>Записей</th><th>Отфильтровано</th><th></th>
                             </thead>
                         </table>
                    </div>
                    
                    <div class="filter_toolbar filter i-bem" data-bem="{&quot;filter&quot;:&quot;true&quot;}">
                        <button class="filter__flag">
                          <span class="filter__text-flag">
                            Флаг
                          </span>
                          <span class="filter__arrow">
                          </span>
                        </button><div class="popup popup_name_flag popup_visibility_hidden i-bem" data-bem="{&quot;popup&quot;:{}}">
                          <div class="popup__content">
                            <ul class="list i-bem" data-bem="{&quot;list&quot;:&quot;true&quot;}">
                              <li class="list__line list__line_checked_yes" val="1" num="1">
                                <span class="list__check">
                                </span>
                                <span class="list__indicate list__indicate_color_green">
                                </span>
                                <span class="list__text">
                                  Не найдено
                                </span>
                              </li>
                              <li class="list__line list__line_checked_yes" val="2" num="2">
                                <span class="list__check">
                                </span>
                                <span class="list__indicate list__indicate_color_yellow">
                                </span>
                                <span class="list__text">
                                  Подозрительный
                                </span>
                              </li>
                              <li class="list__line list__line_checked_yes" val="3" num="3">
                                <span class="list__check">
                                </span>
                                <span class="list__indicate list__indicate_color_red">
                                </span>
                                <span class="list__text">
                                  Вредоносный
                                </span>
                              </li>
                            </ul>
                          </div>
                        </div><button class="filter__columns"><span class="filter__text-columns" id="fileTimeFilterSpan">Поля таблицы</span><span class="filter__arrow"></span></button><div class="popup popup_name_columns popup_visibility_hidden i-bem" data-bem="{&quot;popup&quot;:{}}">
                          <div class="popup__content">
                            <ul class="list i-bem" data-bem="{&quot;list&quot;:&quot;true&quot;}">
                              <li class="list__line list__line_checked_yes" val="0" num="0">
                                <span class="list__check">
                                </span>
                                <span class="list__text">
                                  Флаг
                                </span>
                              </li>
                              <li class="list__line list__line_checked_yes" val="1">
                                <span class="list__check">
                                </span>
                                <span class="list__text">
                                  Путь
                                </span>
                              </li>
                              <li class="list__line list__line_checked_yes" val="2">
                                <span class="list__check">
                                </span>
                                <span class="list__text">
                                  Размер
                                </span>
                              </li>
                              <li class="list__line list__line_checked_yes" val="3">
                                <span class="list__check">
                                </span>
                                <span class="list__text">
                                  Время создания
                                </span>
                              </li>
                              <li class="list__line list__line_checked_yes" val="4">
                                <span class="list__check">
                                </span>
                                <span class="list__text">
                                  Время модификации
                                </span>
                              </li>
                              <li class="list__line" val="5">
                                <span class="list__check">
                                </span>
                                <span class="list__text">
                                  Владелец
                                </span>
                              </li>
                              <li class="list__line" val="6">
                                <span class="list__check">
                                </span>
                                <span class="list__text">
                                  Группа
                                </span>
                              </li>
                              <li class="list__line" val="7">
                                <span class="list__check">
                                </span>
                                <span class="list__text">
                                  Атрибуты
                                </span>
                              </li>              
                            </ul>
                          </div>
                        </div><input class="filter__file-name" placeholder="Путь к файлу" id="filePathSearchFilter"/><button class="filter__timeslot"><input id='dateMin' type='hidden' /><input id='dateMax' type='hidden' />
                        <span class="filter__text-timeslot" id="fileTimeFilterSpan">Временной интервал</span><span class="filter__arrow"></span></button><div class="popup popup_name_timeslot popup_visibility_hidden i-bem" id="fileTimeFilterPopup" data-bem="{&quot;popup&quot;:{}}">
                        <div class="popup__content"><div class="m-datepicker m-datepicker_type_month m-datepicker_disable_change i-bem" data-bem="{&quot;m-datepicker&quot;:&quot;true&quot;}"></div></div>
                        </div><input accept="application/zip, text/xml" style="opacity:0;position: absolute;" type="file" name="report" onchange="turnOnTableScreen(); readText(this);"><button class="filter__filter-button filter__filter-button_theme_action">          
                          Фильтр из файла          
                        </button>
                        </input>
                    </div>
                </div>
      </div>

      <div class="body__content body__content_display_block">

       <table class="table" id="filesTable">
            <thead class="table__head">
                <th class="table__head-item table__head-item_type_flag"><span class="table__column-title" id="tableHeaderFlagSpan">Флаг</span>
                </th>
                <th class="table__head-item table__head-item_type_Filename"><span class="table__column-title table__column-title_sort_up">Имя файла</span>
                </th>
                <th class="table__head-item table__head-item_type_Size"><span class="table__column-title table__column-title_sort_down">Размер</span>
                </th>
                <th class="table__head-item table__head-item_type_Created"><span class="table__column-title">Создан</span>
                </th>
                <th class="table__head-item table__head-item_type_Modified"><span class="table__column-title">Изменен</span>
                </th>
                <th class="table__head-item table__head-item_type_Created"><span class="table__column-title">Владелец</span>
                </th>
                <th class="table__head-item table__head-item_type_Modified"><span class="table__column-title">Группа</span>
                </th>
                <th class="table__head-item table__head-item_type_Modified"><span class="table__column-title">Атрибуты</span>
                </th>
                <th class="table__head-item table__head-item_type_button">Действие</th>
                <th class="table__head-item table__head-item_type_Modified">Хэш-сумма</th>
            </thead>

        <tbody class="table__body">

        </tbody>
      </table>

        <p class="paragraph">
          Созданное предписание можно запустить в выполняторе предписаний Manul
        </p>
        <form class="form">
          <h3 class="form__head">
            Предписание
          </h3>
          <div class="form__textarea-wrapper">
            <textarea class="form__textarea" id="recipeTextarea">
            </textarea>
          </div>
          <div class="form__buttonarea form__buttonarea_align_right">
            <button class="button button_theme_action i-bem" data-bem="{&quot;button&quot;:{}}" role="button" id="copyRecipeButton">
              Копировать
            </button>
          </div>
        </form>
      </div>
      <div class="footer">
        <a class="b-link footer__item" href="#">
          Обратная связь
        </a>
        <a class="b-link footer__item" href="#">
          Помощь
        </a>
        <div class="footer__item footer__item_type_copyright">
          ©&nbsp;2001&mdash;2013
        </div>
      </div>
    </div>

    <script>
        var logLoaded = false;
        var filesDataTable = null;
        var numberItemsInFilter;

        function parseWebsiteLog(fileDictDict) {
			var fileInfoArrayArray = new Array;
			for(var fileDictName in fileDictDict) {
				var fileInfoArray = new Array;
				var fileDict = fileDictDict[fileDictName];
				fileInfoArray.push(fileDict['_detected']);
				fileInfoArray.push(fileDict['path']);
				fileInfoArray.push(fileDict['size']);
				fileInfoArray.push(fileDict.ctime);
				fileInfoArray.push(fileDict.mtime);
				fileInfoArray.push(fileDict['owner']);
				fileInfoArray.push(fileDict['group']);
				fileInfoArray.push(fileDict['access']);
				fileInfoArray.push({'md5': fileDict.md5, 'pos': fileDict._pos, 'snippet': fileDict._snippet, 'path': fileDict.path});
                fileInfoArray.push(fileDict.md5);
				fileInfoArrayArray.push(fileInfoArray);
			}
			return fileInfoArrayArray;             
        }

        function parseWhitelist(fileDictDict) {
            whitelist = {};
			for(var fileDictName in fileDictDict) {
			    fileDict = fileDictDict[fileDictName];
			    if (fileDict.md5 && fileDict.md5.length > 1) {
    			    whitelist[fileDict.md5] = fileDict.path;
    			}
			}			
			console.log(Object.keys(whitelist).length + ' items in filter');
			return whitelist;             
        }

        var cmsDictList;
		function getFileInfoArray(json) {
		    console.log('!@');
		    console.log(json);
			var fileDictDict;
			if (json.hasOwnProperty('website_info')) {                 
    			cmsDictList = json.website_info.cms_list;    			
			    //website log
			    fileDictDict = json.website_info.files.file;
			    return parseWebsiteLog(fileDictDict);
			}
		}

		function getFilter(json) {		    
			if (json.hasOwnProperty('website_info')) {                 
			    //another log
			    var website_log_filter = parseWhitelist(json.website_info.files.file);
			    applyFilter('websitelog', website_log_filter);
			    return true;
			} else if (json.hasOwnProperty('whitelist')) {
			    //whitelist file
			    var whitelist_name = json.whitelist.meta.name + "_" + json.whitelist.meta.version;
			    console.log('Whitelist ' + whitelist_name + ' was loaded.');
			    var whitelist_filter = parseWhitelist(json.whitelist.files);
			    applyFilter(whitelist_name, whitelist_filter)
			    return true;
			} 
		}

		function downloadWhitelist(cms_name, cms_version) {
		    //FIXME
		    url = "http://manul.ml/downloads/get_wl.php?name=" + cms_name.toLowerCase() + "&version=" + cms_version + "&format=json";
		    console.log('Fetching whitelist from ' + url);
			$.ajax({ type: "GET",   
					 url: url,   
					 async: false,
					 success : function(text)
					 {					     
						 whitelist_json = JSON.parse(text);
						 getFilter(whitelist_json);						 
						 console.log('Whitelist for ' + cms_name + ' ' + cms_version + ' was downloaded');
					 }
			});									
		}

		function tryDownloadWhitelist() {
    		for(var index in cmsDictList) {
    		    cms = cmsDictList[index];
       		    console.log('Trying to download whitelist');
    		    console.log(cms._name + ' ' + cms._version);
    		    downloadWhitelist(cms._name, cms._version);
		    }
		}
		//datatable filtering by timeslot and flags
		$.fn.dataTable.ext.search.push(
			function( settings, data, dataIndex ) {
			    var minDateStr = $('#dateMin').val();
			    var maxDateStr = $('#dateMax').val();

 			    var flags = [];
         		$('.popup_name_flag').find('.list__line_checked_yes').each(function(){flags.push(this.getAttribute('val'))});

				var minDate = new Date(minDateStr);
				var maxDate = new Date(maxDateStr);
				var date = new Date(data[4]); // use data for the mtime column

			    var flag = data[0];

				if (flags.indexOf(flag) == -1) {
				    return false;
				} 
        		 
				if ( ( minDateStr == '' && '' == maxDateStr ) ||
				     ( minDateStr == '' && date <= maxDate ) ||
					 ( minDate <= date && '' == maxDateStr ) ||
					 ( minDate <= date && date <= maxDate ) )
				{      
					return true;
				}
				return false;
			}
		);			

        function escapeHtml(text) {
          return text
          			.replace(/&/g, "&amp;")
          			.replace(/</g, "&lt;")
          			.replace(/>/g, "&gt;")
          			.replace(/"/g, "&quot;")
          			.replace(/'/g, "&#039;");
        }

		function buildTrable(data) {

			window.filesDataTable = $('#filesTable').dataTable({
   			   "order": [[ 0, "desc" ]],

			   "aLengthMenu": [[100, 10, 500, -1], [100, 10, 500, "All"]],

			   "iDisplayLength": 50,

			   //Localization
			   "oLanguage": {
					"sLengthMenu": "Отображать по _MENU_ записей",
					"sZeroRecords": "Ничего не найдено",
					"sInfo": "Отображается c _START_ по _END_ из _TOTAL_ файлов",
					"sInfoEmpty": "Нет файлов",
					"sInfoFiltered": "(всего записей _MAX_)",
					"sSearch":       "Поиск:",
					"sUrl":          "",
					"oPaginate": {
						"sFirst": "&nbsp;&nbsp;&nbsp;",
						"sPrevious": "&nbsp;&nbsp;&nbsp;",
						"sNext": "&nbsp;&nbsp;&nbsp;",
						"sLast": "&nbsp;&nbsp;&nbsp;"
					},
					"oAria": {
						"sSortAscending":  ": активировать для сортировки столбца по возрастанию",
						"sSortDescending": ": активировать для сортировки столбцов по убыванию"			
					}
				},
				

				//Data source
				"aaData": data,

				//Data preprocessing for rendering
				"aoColumnDefs": [

					//Detection flag field preprocessing        
					{
						"aTargets": [0],
						"sType": "html",
						"sClass": "table__item",
						//FIXME - profomance issue with tag stripping
						//http://datatables.net/forums/discussion/3896/how-to-apply-sorting-on-hidden-column
						"mRender": function (flag, type, full) {
							if (flag == 'c') {
								return '<span class="table__flag table__flag_color_red"><span style="display:none">3<span></span>';								
							} else if (flag == 'w') {
								return '<span class="table__flag table__flag_color_yellow"><span style="display:none">2</span></span>';
							}
							return '<span class="table__flag table__flag_color_green"><span style="display:none">1</span></span>';							
						}

					},

					//File size field preprocessing
					{
						"aTargets": [2],
						//"sType": "numeric",
						"sClass": "table__item",
						"mRender": function (size, type, full) {
							if (size == -1) {
								//return '[Каталог]';
								return '0';
							}
							return size;
						}
					},

					//Ctime and mtime fields preprocessing        
					{
						"aTargets": [3, 4],
						"sClass": "table__item",
						//"sType": "date",
						"mRender": function (timestamp, type, full) {
							return $.format.date(new Date(timestamp * 1000), "yyyy-MM-dd HH:mm:ss");
						}
					},
					{
						"aTargets": [1],
    					"sClass": "table__item",
    				},
					{
						"aTargets": [5, 6, 7],
    					"sClass": "table__item",
                        "visible": false
    				},
					{
						"aTargets": [8],
						"sClass": "table__item",
						"mRender": function (detectionInfo, type, full) {                        
							var buttons = "<div class=\"button-group i-bem button-group_js_inited\" hash='" + detectionInfo.md5 + "'><div class=\"popup popup_visibility_hidden i-bem popup_js_inited\" data-bem=\"{&quot;popup&quot;:{&quot;0&quot;:&quot;t&quot;,&quot;1&quot;:&quot;r&quot;,&quot;2&quot;:&quot;u&quot;,&quot;3&quot;:&quot;e&quot;}}\"><div class=\"popup__close\"></div><div class=\"popup__content\"><table class=\"table\"><tbody><tr class=\"table__line\"><td class=\"table__item table__item_bold_yes\"> Hash </td><td class=\"table__item\">" + detectionInfo.md5 + "</td></tr></tbody><tr class=\"table__line\"><td class=\"table__item table__item_bold_yes\"> Snippet </td><td class=\"table__item\">" + detectionInfo.snippet + "</td></tr></table></div></div><button class=\"button_more_yes button i-bem\" data-bem=\"{&quot;button&quot;:{}}\" role=\"button\" type=\"button\"><div class=\"button__arrow\"></div></button><button id=\"q_" + detectionInfo.md5 + "\" class=\"button button_size_s i-bem\" data-bem=\"{&quot;button&quot;:{}}\" role=\"button\" onclick=\"return add_quarantine('" + detectionInfo.md5 + "', '" + detectionInfo.path + "')\"><span class=\"button__text\">Карантин</span></button><button id=\"d_" + detectionInfo.md5 + "\" class=\"button button_size_s i-bem\" data-bem=\"{&quot;button&quot;:{}}\" role=\"button\" onclick=\"return add_delete('" + detectionInfo.md5 + "', '" + detectionInfo.path + "')\"><span class=\"button__text\">Удалить</span></button></div>";
							return buttons;
						}
					},
					//md5 hash as a hidden column
                    {
                        "aTargets": [9],
                        "sClass": "table__item",
                        "visible": false
                    }									 
				]
			});		

		}

		function filterColumns() {
			$('.popup_name_columns').find('.list__line').each(function(){
				var column = filesDataTable.DataTable().column( this.getAttribute('val') );
				column.visible( $(this).hasClass('list__line_checked_yes') );				
				console.log(this.getAttribute('val'));
			});
		}

		function filterByFlags() {

		    var flags = [];
     		$('.popup_name_flag').find('.list__line_checked_yes').each(function(){flags.push(this.getAttribute('val'))});
     		console.log($('.popup_name_flag').find('.list__line_checked_yes'));
     		console.log(flags);
     		filesDataTable.DataTable().draw();
		}	

		function applyFilter(filter_name, filter) {
		    filters[filter_name] = filter;
	        filter_stat[filter_name] = {'total': Object.keys(filters[filter_name]).length, 'filtered': 0}

		    //reset counter for each filter because stats is calculated 
			//for all filters again every time new filter is added
			$.each(filter_stat, function(name, stat) {
    		   filter_stat[name]['filtered'] = 0;
			});

	    	remove_control = '<a onclick="console.log($(this).parent().parent());" href="#">X</a>'
	    	row = '<tr><td>' + filter_name + '</td><td>' + filter_stat[filter_name]['total'] + '</td>';
	    	row += '<td id="fb_' + filter_name +'">' + filter_stat[filter_name]['filtered'] + '</td><td><input type="button" value="X" class="filter_list_button_remove"/></td></tr>';
    		$('#filter_file_list tr:last').after(row);
			$('.filter_list').css('visibility', 'visible');
            
            //redraw the table with newly added filter				
		    $("#filesTable").dataTable().fnDraw();

			//WTF jquery selector doesn't work here
			$(document.getElementById('fb_' + filter_name)).text(filter_stat[filter_name]['filtered']);
		}
		
		var data = "";
		var new_data = "";
		var filters = {};
		function displayContents(xmlStr) {
		    if (logLoaded) {
		        //loading filters from files		        
		        var new_json = parseXMLstrToJSON(xmlStr);		        
				getFilter(new_json);							
		    } else {
     		    //loading log from file
				logLoaded = true;	
				var json = parseXMLstrToJSON(xmlStr);
				data = getFileInfoArray(json);
				buildTrable(data);      				
     			tryDownloadWhitelist();
			}					
		};

    	$('#filter_file_list').on('click', 'input[type="button"]', function(e){
    	    row = $(this).closest('tr');
            row.remove();
            filename = row.children().first().text();            

            //remove filename from filter_list
            delete filters[filename];
            delete filter_stat[filename];

            if (Object.keys(filters).length <= 0) {
                $('.filter_list').css('visibility', 'hidden');
            }
            //redraw table
            $("#filesTable").dataTable().fnDraw();      
        });

        //whitelist filtering
        var filter_stat = {}
        $.fn.dataTableExt.afnFiltering.push(
                function( oSettings, aData, iDataIndex )
                {
                    var row = oSettings.aoData[iDataIndex].nTr;
                    filepath = $(row).children().eq(1).text();
                    hash = $(row).children().last().children().first().attr('hash');
                    var is_whitelisted = false;
                    $.each(filters, function(filter_name, filter) {
                        if (filter.hasOwnProperty(hash)) {
                            filter_stat[filter_name]['filtered'] += 1;                            
                            is_whitelisted = true;
                        }                        
                    });                    
                    return !is_whitelisted;
                }
            ); 			
    </script>
    
    <script type="text/javascript" src="js/analyzer.table.js" defer></script>
    <script type="text/javascript">

        var client = new ZeroClipboard(document.getElementById("copyRecipeButton"), {
          moviePath: "//cdnjs.cloudflare.com/ajax/libs/zeroclipboard/1.3.5/ZeroClipboard.swf"
        });

        client.on("load", function(client) {
          client.on('dataRequested', function (client, args) {
              client.setText(document.getElementById('recipeTextarea').value);
          });
        });

     function turnOnTableScreen() {
         $('#uploadScreen').hide();		
         $('.popup_name_flag').find('.list_js_inited').change(filterByFlags);
         $('.popup_name_columns').find('.list_js_inited').change(filterColumns);
		 $('#dateMin').change( function() { console.log(this.value); filesDataTable.DataTable().draw(); } );
		 $('#dateMax').change( function() { console.log(this.value); filesDataTable.DataTable().draw(); } );
         $('#filePathSearchFilter').keyup(function(){filesDataTable.fnFilter($('#filePathSearchFilter').val(), 1);}); 
     }

    </script>
  </div>
  </body>
</html>
